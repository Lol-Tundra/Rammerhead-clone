<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rammerhead Browser</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      body {
        background-color: #000000;
        color: #e0e0e0;
        font-family: 'Inter', sans-serif;
        overflow: hidden;
        margin: 0;
        padding: 0;
      }
      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }
      ::-webkit-scrollbar-track {
        background: #1a1a1a;
      }
      ::-webkit-scrollbar-thumb {
        background: #333;
        border-radius: 5px;
        border: 2px solid #1a1a1a;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
      iframe {
        border: none;
        width: 100%;
        height: 100%;
      }
      
      @keyframes progress {
        0% { width: 0%; }
        50% { width: 70%; }
        100% { width: 100%; }
      }
      .animate-progress {
        animation: progress 2s infinite ease-in-out;
      }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- ICONS (Inlined for single-file portability) ---
        const IconBase = ({ children, className, ...props }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width="24" 
                height="24" 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className} 
                {...props}
            >
                {children}
            </svg>
        );

        const XIcon = (props) => <IconBase {...props}><path d="M18 6 6 18"/><path d="M6 6 18 18"/></IconBase>;
        const PlusIcon = (props) => <IconBase {...props}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const GlobeIcon = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/><path d="M2 12h20"/></IconBase>;
        const ArrowLeftIcon = (props) => <IconBase {...props}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></IconBase>;
        const ArrowRightIcon = (props) => <IconBase {...props}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></IconBase>;
        const RotateCwIcon = (props) => <IconBase {...props}><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></IconBase>;
        const SearchIcon = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase>;
        const HomeIcon = (props) => <IconBase {...props}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></IconBase>;
        const LockIcon = (props) => <IconBase {...props}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>;

        // --- COMPONENTS ---

        // TabBar Component
        const TabBar = ({ tabs, activeTabId, onSwitchTab, onCloseTab, onNewTab }) => {
            return (
                <div className="flex items-end bg-[#000000] h-9 px-2 pt-1 gap-1 select-none overflow-x-auto border-b border-[#333]">
                    {tabs.map((tab) => {
                        const isActive = tab.id === activeTabId;
                        return (
                            <div
                                key={tab.id}
                                onClick={() => onSwitchTab(tab.id)}
                                className={`
                                    group relative flex items-center min-w-[140px] max-w-[240px] h-full px-3 pr-8 rounded-t-md cursor-pointer transition-colors border-t border-x
                                    ${isActive 
                                        ? 'bg-[#181818] text-gray-200 border-[#333] border-b-[#181818]' 
                                        : 'bg-[#0a0a0a] text-gray-500 hover:bg-[#111] hover:text-gray-300 border-transparent'
                                    }
                                `}
                            >
                                {tab.isLoading ? (
                                    <div className="animate-spin h-3 w-3 mr-2 border-2 border-red-600 border-t-transparent rounded-full flex-shrink-0"></div>
                                ) : (
                                    <GlobeIcon className={`w-3 h-3 mr-2 flex-shrink-0 ${isActive ? 'text-red-500' : 'opacity-50'}`} />
                                )}
                                <span className="text-xs truncate font-mono">{tab.title || 'New Tab'}</span>
                                
                                <button
                                    onClick={(e) => onCloseTab(tab.id, e)}
                                    className={`
                                        absolute right-2 top-1/2 -translate-y-1/2 p-0.5 rounded-sm hover:bg-red-900/50 hover:text-red-200 opacity-0 group-hover:opacity-100 transition-opacity
                                        ${isActive ? 'opacity-100' : ''}
                                    `}
                                >
                                    <XIcon className="w-3 h-3" />
                                </button>
                            </div>
                        );
                    })}
                    
                    <button
                        onClick={onNewTab}
                        className="flex items-center justify-center w-8 h-full text-gray-500 hover:text-white hover:bg-[#1a1a1a] rounded-t-md ml-1"
                        title="New Tab"
                    >
                        <PlusIcon className="w-4 h-4" />
                    </button>
                </div>
            );
        };

        // AddressBar Component
        const AddressBar = ({ 
            url, 
            isLoading, 
            onNavigate, 
            onReload,
            canGoBack,
            canGoForward,
            onBack,
            onForward,
            onHome
        }) => {
            const [inputVal, setInputVal] = useState(url);

            useEffect(() => {
                setInputVal(url);
            }, [url]);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!inputVal.trim()) return;
                
                let target = inputVal.trim();
                // Basic URL fixing
                if (!target.startsWith('http') && target.includes('.')) {
                    target = `https://${target}`;
                } else if (!target.startsWith('http')) {
                    // Bing Search fallback
                    target = `https://www.bing.com/search?q=${encodeURIComponent(target)}`;
                }
                onNavigate(target);
            };

            return (
                <div className="bg-[#181818] p-2 flex items-center gap-2 border-b border-[#333] shadow-sm z-20">
                    <div className="flex gap-1 text-gray-400">
                        <button 
                            onClick={onBack}
                            disabled={!canGoBack}
                            className="p-1.5 rounded hover:bg-white/10 disabled:opacity-30 transition-colors"
                        >
                            <ArrowLeftIcon className="w-4 h-4" />
                        </button>
                        <button 
                            onClick={onForward}
                            disabled={!canGoForward}
                            className="p-1.5 rounded hover:bg-white/10 disabled:opacity-30 transition-colors"
                        >
                            <ArrowRightIcon className="w-4 h-4" />
                        </button>
                        <button 
                            onClick={onReload}
                            className={`p-1.5 rounded hover:bg-white/10 transition-colors ${isLoading ? 'animate-spin' : ''}`}
                        >
                            <RotateCwIcon className="w-4 h-4" />
                        </button>
                        <button 
                            onClick={onHome}
                            className="p-1.5 rounded hover:bg-white/10 transition-colors"
                        >
                            <HomeIcon className="w-4 h-4" />
                        </button>
                    </div>

                    <form onSubmit={handleSubmit} className="flex-1 relative group">
                        <div className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 group-focus-within:text-white transition-colors">
                            {url.startsWith('https') ? <LockIcon className="w-3 h-3" /> : <SearchIcon className="w-3 h-3" />}
                        </div>
                        <input
                            type="text"
                            value={inputVal}
                            onChange={(e) => setInputVal(e.target.value)}
                            placeholder="Search with Bing or enter URL..."
                            className="w-full bg-[#0a0a0a] text-gray-200 text-sm rounded-md py-1.5 pl-9 pr-4 focus:outline-none focus:ring-1 focus:ring-red-900 border border-[#333] focus:border-red-800 transition-all font-mono"
                        />
                    </form>
                </div>
            );
        };

        // BrowserContent Component
        const BrowserContent = ({ activeTab, onNavigate, onLoadStart, onLoadEnd }) => {
            const [homeInput, setHomeInput] = useState('');

            const handleHomeSubmit = (e) => {
                e.preventDefault();
                if (!homeInput.trim()) return;
                
                let target = homeInput.trim();
                if (!target.startsWith('http') && target.includes('.')) {
                    target = `https://${target}`;
                } else if (!target.startsWith('http')) {
                    target = `https://www.bing.com/search?q=${encodeURIComponent(target)}`;
                }
                onNavigate(target);
            };

            // Calculate Proxy URL
            // We use the same origin (e.g., localhost:3000) and append /proxy?url=
            const getProxyUrl = (targetUrl) => {
                if (!targetUrl) return '';
                // Check if already proxied to avoid double proxying if user pastes a proxy link
                if (targetUrl.includes('/proxy?url=')) return targetUrl;
                
                return `/proxy?url=${encodeURIComponent(targetUrl)}`;
            };

            const proxySrc = getProxyUrl(activeTab.url);

            // If no URL is present, show the Rammerhead-style home page
            if (!activeTab.url) {
                return (
                    <div className="flex flex-col items-center justify-center h-full bg-black text-white relative overflow-hidden">
                        {/* Abstract background blobs for style */}
                        <div className="absolute top-[-20%] left-[-10%] w-[500px] h-[500px] bg-red-900/20 rounded-full blur-[100px] pointer-events-none"></div>
                        <div className="absolute bottom-[-20%] right-[-10%] w-[500px] h-[500px] bg-blue-900/10 rounded-full blur-[100px] pointer-events-none"></div>

                        <div className="z-10 w-full max-w-2xl px-6 flex flex-col items-center">
                            <h1 className="text-6xl font-bold mb-2 tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-gray-100 to-gray-500">
                                Rammerhead
                            </h1>
                            <p className="text-gray-500 mb-12 font-mono text-sm tracking-widest uppercase">
                                Advanced Web Proxy Client
                            </p>

                            <form onSubmit={handleHomeSubmit} className="w-full relative">
                                <input
                                    type="text"
                                    value={homeInput}
                                    onChange={(e) => setHomeInput(e.target.value)}
                                    placeholder="Search Bing or type a URL"
                                    className="w-full bg-[#111] border border-[#333] text-white p-4 pl-6 rounded-full shadow-2xl focus:outline-none focus:border-gray-500 focus:ring-1 focus:ring-gray-500 transition-all text-lg placeholder-gray-600"
                                    autoFocus
                                />
                                <button 
                                    type="submit"
                                    className="absolute right-3 top-1/2 -translate-y-1/2 p-2 bg-[#222] rounded-full text-gray-400 hover:text-white hover:bg-[#333] transition-all"
                                >
                                    <SearchIcon className="w-5 h-5" />
                                </button>
                            </form>

                            <div className="mt-8 flex gap-6 text-sm text-gray-500 font-mono">
                                <a href="#" className="hover:text-red-400 hover:underline transition-colors">Discord</a>
                                <a href="#" className="hover:text-red-400 hover:underline transition-colors">GitHub</a>
                                <a href="#" className="hover:text-red-400 hover:underline transition-colors">Privacy</a>
                            </div>
                        </div>
                    </div>
                );
            }

            // If URL is present, render the iframe "browser"
            return (
                <div className="w-full h-full bg-white relative">
                    {activeTab.isLoading && (
                        <div className="absolute top-0 left-0 w-full h-1 bg-gray-200 z-50">
                            <div className="h-full bg-red-600 animate-progress"></div>
                        </div>
                    )}
                    <iframe
                        key={activeTab.id}
                        src={proxySrc}
                        title={activeTab.title}
                        className="w-full h-full border-none bg-white"
                        // Sandbox removed to allow Poki games and Video DRM
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen"
                        allowFullScreen={true}
                        onLoad={onLoadEnd}
                    />
                    
                    {/* Overlay for sites that refuse to connect (basic hint) */}
                    <div className="hidden peer-has-[:error]:flex absolute inset-0 bg-[#111] text-gray-400 flex-col items-center justify-center pointer-events-none">
                        <p>Could not connect to {activeTab.url}</p>
                    </div>
                </div>
            );
        };

        // --- APP MAIN ---

        const generateId = () => Math.random().toString(36).substr(2, 9);

        const INITIAL_TAB = {
            id: generateId(),
            url: '',
            title: 'New Tab',
            isLoading: false,
            history: [],
            historyIndex: -1,
        };

        const App = () => {
            const [tabs, setTabs] = useState([INITIAL_TAB]);
            // If INITIAL_TAB.id is called again it will differ, so we must set initial state carefully or use the object above
            // Fix: Re-initialize to ensure matching IDs
            const [activeTabId, setActiveTabId] = useState(tabs[0].id);

            const activeTab = tabs.find(t => t.id === activeTabId) || tabs[0];

            const updateTab = (id, updates) => {
                setTabs(prev => prev.map(tab => tab.id === id ? { ...tab, ...updates } : tab));
            };

            const handleNavigate = (url, tabId = activeTabId, addToHistory = true) => {
                const currentTab = tabs.find(t => t.id === tabId);
                if (!currentTab) return;

                // Update history
                let newHistory = [...currentTab.history];
                let newIndex = currentTab.historyIndex;

                if (addToHistory && url !== currentTab.url) {
                    if (newIndex < newHistory.length - 1) {
                        newHistory = newHistory.slice(0, newIndex + 1);
                    }
                    newHistory.push(url);
                    newIndex = newHistory.length - 1;
                }

                updateTab(tabId, { 
                    isLoading: true, 
                    url, 
                    title: url, 
                    history: newHistory,
                    historyIndex: newIndex
                });
            };

            const handleNewTab = () => {
                const newTab = {
                    id: generateId(),
                    url: '',
                    title: 'New Tab',
                    isLoading: false,
                    history: [],
                    historyIndex: -1
                };
                setTabs(prev => [...prev, newTab]);
                setActiveTabId(newTab.id);
            };

            const handleCloseTab = (id, e) => {
                e.stopPropagation();
                if (tabs.length === 1) {
                    // Reset the last tab instead of removing it
                    const newId = generateId();
                    // We must update the tabs array AND the activeTabId if we are closing the active one
                    // Easier to just reset the current tab content
                    updateTab(id, { 
                        url: '', 
                        title: 'New Tab', 
                        isLoading: false, 
                        history: [], 
                        historyIndex: -1 
                    });
                    return;
                }
                
                const newTabs = tabs.filter(t => t.id !== id);
                setTabs(newTabs);
                
                if (activeTabId === id) {
                    setActiveTabId(newTabs[newTabs.length - 1].id);
                }
            };

            const handleBack = () => {
                if (activeTab.historyIndex > 0) {
                    const newIndex = activeTab.historyIndex - 1;
                    const prevUrl = activeTab.history[newIndex];
                    handleNavigate(prevUrl, activeTabId, false);
                    updateTab(activeTabId, { historyIndex: newIndex });
                }
            };

            const handleForward = () => {
                if (activeTab.historyIndex < activeTab.history.length - 1) {
                    const newIndex = activeTab.historyIndex + 1;
                    const nextUrl = activeTab.history[newIndex];
                    handleNavigate(nextUrl, activeTabId, false);
                    updateTab(activeTabId, { historyIndex: newIndex });
                }
            };

            const handleReload = () => {
                if (activeTab.url) {
                    updateTab(activeTabId, { isLoading: true });
                    setTimeout(() => updateTab(activeTabId, { isLoading: false }), 100);
                }
            };
            
            const handleHome = () => {
                handleNavigate('', activeTabId, true);
                updateTab(activeTabId, { title: 'New Tab', isLoading: false });
            };

            const handleIframeLoadEnd = () => {
                updateTab(activeTabId, { isLoading: false });
            };

            const handleIframeLoadStart = () => {
                updateTab(activeTabId, { isLoading: true });
            };

            return (
                <div className="flex flex-col h-screen bg-black text-gray-200 overflow-hidden font-sans">
                    <TabBar 
                        tabs={tabs} 
                        activeTabId={activeTabId} 
                        onSwitchTab={setActiveTabId} 
                        onCloseTab={handleCloseTab}
                        onNewTab={handleNewTab}
                    />
                    <AddressBar 
                        url={activeTab.url} 
                        isLoading={activeTab.isLoading}
                        onNavigate={(url) => handleNavigate(url)}
                        onReload={handleReload}
                        canGoBack={activeTab.historyIndex > 0}
                        canGoForward={activeTab.historyIndex < activeTab.history.length - 1}
                        onBack={handleBack}
                        onForward={handleForward}
                        onHome={handleHome}
                    />
                    <div className="flex-1 relative overflow-hidden bg-[#121212]">
                        <BrowserContent 
                            activeTab={activeTab} 
                            onNavigate={(url) => handleNavigate(url)}
                            onLoadStart={handleIframeLoadStart}
                            onLoadEnd={handleIframeLoadEnd}
                        />
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
